<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <!-- <link rel="shortcut icon" href="">
    -->
    <!-- 指定title前面的图标 -->

    <title>{% block title %}{% endblock %}</title>

    <link rel="stylesheet" href="http://cdn.bootcss.com/twitter-bootstrap/3.0.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/themes/base/jquery-ui.css" id="theme">
    <link rel="stylesheet" type="text/css" href="/static/css/jquery.fileupload-ui.css">
    <link rel="stylesheet" type="text/css" href="/static/css/base.css">
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="stylesheet" type="text/css" href="/static/css/reset.css">
    {% load staticfiles %}
    {% block extracss %}{% endblock %}
    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]>
    <script src="../../docs-assets/js/ie8-responsive-file-warning.js"></script>
    <![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.min.js"></script>
    <script src="http://cdn.bootcss.com/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <!-- jQuery Templates -->
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>

    <!-- Fixing CSRF in Django for jQuery -->
    <script src="/static/js/jquery_fix_csrf.js"></script>

    <!-- jQuery Upload files -->
    <script src="/static/js/jquery.iframe-transport.js"></script>
    <script src="/static/js/jquery.fileupload.js"></script>
    <script src="/static/js/jquery.fileupload-ui.js"></script>

    <script type="text/javascript">
        $(function() {
            'use strict';

            // Initialize the jQuery File Upload widget
            // For a complete option reference go to
            // https://github.com/blueimp/jQuery-File-Upload
            $('#fileupload').fileupload({
                // this formData is neccessary to pass the csrf and pass uid to django
                formData: [
                    // { name: "uid", value: "{{ uid }}"},
                    { name: "albums", value: "{{ albums }}"},
                    { name: "csrfmiddlewaretoken", value: "{{ csrf_token }}"}
                ],
                maxFileSize: {{ maxfilesize }},
                minFileSize: {{ minfilesize }},
                sequentialUploads: true
            });

            // Load existing files
            $.getJSON($('#fileupload form').prop('action'), function (files) {
                var fu = $('#fileupload').data('fileupload');
                fu._adjustMaxNumberOfFiles(-files.length);
                fu._renderDownload(files)
                        .appendTo($('#fileupload .files'))
                        .fadeIn(function () {
                            // Fix for IE7 and lower:
                            $(this).show();
                        });
            });

            // Open download dialogs via iframes,
            // to prevent aborting current uploads
            $('#fileupload .files a:not([target^=_blank])').live('click', function (e) {
                e.preventDefault();
                $('<iframe style="display:none;"></iframe>')
                        .prop('src', this.href)
                        .appendTo('body');
            });
        });
    </script>
</head>

<body style="">
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">微图</a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="">
                        <a href="/">首页</a>
                    </li>
                    <!-- <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        分类 <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#">分类1</a>
                        </li>
                        <li>
                            <a href="#">分类2</a>
                        </li>
                    </ul>
                </li>
                -->
            </ul>
            <ul class="nav navbar-nav navbar-right">
                {% if user.is_authenticated %}
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        发布 <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a id="upload-img" href="javascript:;">上传图片</a>
                            <div id="fileupload" title="上传图片">
                                <form action="{% url 'gallery.views.upload' %}" method="POST" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="fileupload-body">
                                        <div class="fileinput-button">
                                            <span>选择图片...</span>
                                            <input type="file" name="files[]" multiple></div>
                                        <div>
                                            <!-- 选择图片 -->
                                            <select id="album-selector" name="selector"></select>
                                        </div>
                                        <div class="photo-desc">
                                            <textarea name="photo_description"></textarea>
                                        </div>
                                        <div class="">
                                            <!-- 发布按钮 -->
                                            <button type="submit" class="btn btn-primary">发布</button>
                                        </div>
                                    </div>
                                    <div class="fileupload-content">
                                        <table class="files"></table>
                                        <div class="fileupload-progressbar"></div>
                                    </div>
                                </form>
                            </div>
                        </li>
                        <li>
                            <a id="create-album" href="javascript:;">创建专辑</a>
                            <div id="albumcreate" title="创建专辑">
                                <form action="{% url 'gallery.views.create_album' %}" method="POST">
                                    {% csrf_token %}
                                    <div>
                                        <label for="name">名称</label>
                                        <input class="" type="text" name="album_name"></div>
                                    <div>
                                        <label for="description">描述</label>
                                        <textarea class="" name="album_description"></textarea>
                                    </div>
                                    <input type="submit" value="创建"></form>
                            </div>
                        </li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        {{user}}的帐号
                        <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#">个人主页</a>
                        </li>
                        <li>
                            <a href="../logout/">退出</a>
                        </li>
                    </ul>
                </li>
                {% else %}
                <li>
                    <a href="../register/">注册</a>
                </li>
                <li class="">
                    <a href="../login/">登录</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
<div class="container">{% block content %}{% endblock %}</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script src="/static/js/bootstrap.js"></script>
<script type="text/javascript">
    $( "#fileupload" ).dialog({
        autoOpen: false,
        height: 375,
        width: 500,
        modal: true,
        close: function() {
            allFields.val( "" ).removeClass( "ui-state-error" );
        }
    });
    $( "#upload-img" )
        .button()
        .click(function() {
            //查询用户的所有专辑
            selector = $('#album-selector');
            $.getJSON("/request_albums/" + {{ user.id }} + "/",
                function(data) {
                    jQuery.each(data, function() {
                        selector.append('<option class="'
                            + '">' + this.fields.name + '</option>'
                        );
                    });
                }
            );
            $( "#fileupload" ).dialog( "open" );
    });
    $( "#albumcreate" ).dialog({
        autoOpen: false,
        height: 375,
        width: 500,
        modal: true,
    });
    $( "#create-album" )
        .button()
        .click(function() {
            $( "#albumcreate" ).dialog( "open" );
    });
</script>
<script id="template-upload" type="text/x-jquery-tmpl">
    <tr class="template-upload{{ open_tv }}if error{{ close_tv }} ui-state-error{{ open_tv }}/if{{ close_tv }}">
        <td class="preview"></td>
        <td><select name="album">
        {{ open_tv }} for item in albums
        <option value="">{{ item.name }}</option>
        {{ close_tv }}
        </select></td>
        {{ open_tv }}if error{{ close_tv }}
        <td class="error" colspan="2">Error:
            {{ open_tv }}if error === 'maxFileSize'{{ close_tv }}File is too big
            {{ open_tv }}else error === 'minFileSize'{{ close_tv }}File is too small
            {{ open_tv }}else error === 'acceptFileTypes'{{ close_tv }}Filetype not allowed
            {{ open_tv }}else error === 'maxNumberOfFiles'{{ close_tv }}Max number of files exceeded
            {{ open_tv }}else{{ close_tv }}${error}
            {{ open_tv }}/if{{ close_tv }}
        </td>
        {{ open_tv }}else{{ close_tv }}
        <td class="progress">
            <div></div>
        </td>
        {{ open_tv }}/if{{ close_tv }}
        <td class="cancel">
            <button>Cancel</button>
        </td>
    </tr>
</script>
{% load staticfiles %}
{% block extrajs %}{% endblock %}
</body>
</html>